name: Release on Tag

# Este workflow cria releases APENAS quando voc√™ criar uma tag
# Para usar este ao inv√©s do autom√°tico, renomeie este arquivo para build-and-release.yml
# e renomeie o outro para build-and-release.yml.disabled

on:
  push:
    tags:
      - 'v*'  # Dispara apenas em tags como v1.0.0, v2.1.3, etc.

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build execut√°vel com PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed `
            --collect-all customtkinter `
            --collect-all pystray `
            --collect-all PIL `
            --add-data "app/assets;app/assets" `
            --icon "app/assets/icon.ico" `
            --name "MikroTikRoutes" `
            main.py
      
      - name: Verificar se o execut√°vel foi criado
        run: |
          if (Test-Path "dist\MikroTikRoutes.exe") {
            Write-Host "‚úÖ Execut√°vel gerado com sucesso!"
            $size = (Get-Item "dist\MikroTikRoutes.exe").Length / 1MB
            Write-Host "üì¶ Tamanho: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "‚ùå Falha ao gerar o execut√°vel"
            exit 1
          }
      
      - name: Extrair informa√ß√µes da tag
        id: tag_info
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
      
      - name: Criar Release
        uses: softprops/action-gh-release@v1
        with:
          name: MikroTikRoutes ${{ steps.tag_info.outputs.version }}
          body: |
            ## üöÄ MikroTik Link Dashboard
            
            **Vers√£o:** `${{ steps.tag_info.outputs.version }}`
            **Tag:** `${{ github.ref_name }}`
            **Commit:** `${{ github.sha }}`
            
            ### üì• Download
            Baixe o arquivo `MikroTikRoutes.exe` abaixo e execute diretamente no Windows.
            
            ### ‚ú® Funcionalidades
            - Troca de links MikroTik com um clique
            - Descoberta autom√°tica de links via coment√°rios nas rotas
            - Monitoramento de lat√™ncia em tempo real
            - Modo failover autom√°tico
            - Minimiza para bandeja do sistema
            - Armazenamento seguro de credenciais (Windows Keyring)
            
            ### üìù Notas da Vers√£o
            <!-- Adicione aqui as mudan√ßas desta vers√£o -->
            
            ---
            *Para criar uma nova release, use: `git tag -a v1.0.0 -m "Descri√ß√£o" && git push origin v1.0.0`*
          files: |
            dist/MikroTikRoutes.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artefato (backup)
        uses: actions/upload-artifact@v4
        with:
          name: MikroTikRoutes-Windows-${{ steps.tag_info.outputs.version }}
          path: dist/MikroTikRoutes.exe
          retention-days: 90
