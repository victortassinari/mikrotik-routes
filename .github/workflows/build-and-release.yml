name: Build and Release Windows

on:
  push:
    branches:
      - main
      - master
    # Opcional: descomentar para fazer release apenas em tags
    # tags:
    #   - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build execut√°vel com PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed `
            --collect-all customtkinter `
            --collect-all pystray `
            --collect-all PIL `
            --add-data "app/assets;app/assets" `
            --icon "app/assets/icon.ico" `
            --name "MikroTikRoutes" `
            main.py
      
      - name: Verificar se o execut√°vel foi criado
        run: |
          if (Test-Path "dist\MikroTikRoutes.exe") {
            Write-Host "‚úÖ Execut√°vel gerado com sucesso!"
            $size = (Get-Item "dist\MikroTikRoutes.exe").Length / 1MB
            Write-Host "üì¶ Tamanho: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "‚ùå Falha ao gerar o execut√°vel"
            exit 1
          }
      
      - name: Gerar nome da release
        id: release_info
        run: |
          $timestamp = Get-Date -Format "yyyy.MM.dd-HHmm"
          $short_sha = "${{ github.sha }}".Substring(0, 7)
          $release_tag = "v$timestamp-$short_sha"
          $release_name = "MikroTikRoutes $timestamp"
          
          echo "tag=$release_tag" >> $env:GITHUB_OUTPUT
          echo "name=$release_name" >> $env:GITHUB_OUTPUT
          echo "timestamp=$timestamp" >> $env:GITHUB_OUTPUT
      
      - name: Criar Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: ${{ steps.release_info.outputs.name }}
          body: |
            ## üöÄ MikroTik Link Dashboard - Build Autom√°tico
            
            **Vers√£o:** `${{ steps.release_info.outputs.tag }}`
            **Commit:** `${{ github.sha }}`
            **Branch:** `${{ github.ref_name }}`
            **Data:** `${{ steps.release_info.outputs.timestamp }}`
            
            ### üì• Download
            Baixe o arquivo `MikroTikRoutes.exe` abaixo e execute diretamente no Windows.
            
            ### ‚ú® Funcionalidades
            - Troca de links MikroTik com um clique
            - Descoberta autom√°tica de links via coment√°rios nas rotas
            - Monitoramento de lat√™ncia em tempo real
            - Modo failover autom√°tico
            - Minimiza para bandeja do sistema
            - Armazenamento seguro de credenciais (Windows Keyring)
            
            ### üìù Changelog
            ${{ github.event.head_commit.message }}
            
            ---
            *Build gerado automaticamente via GitHub Actions*
          files: |
            dist/MikroTikRoutes.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artefato (backup)
        uses: actions/upload-artifact@v4
        with:
          name: MikroTikRoutes-Windows-${{ steps.release_info.outputs.timestamp }}
          path: dist/MikroTikRoutes.exe
          retention-days: 30
